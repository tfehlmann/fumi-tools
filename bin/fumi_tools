#!/usr/bin/env python

import argparse
import subprocess
import sys

def ext_check(*args):
    def extension(filename):
        for a in args:
            if filename.endswith(a):
                return filename
        raise ValueError
    return extension

parser = argparse.ArgumentParser()
parser.add_argument("-i", "--input", help="Input SAM or BAM file.", required=True, type=ext_check(".bam", ".sam", "-"))
parser.add_argument("-o", "--output", help="Output SAM or BAM file. To output SAM on stdout use '-'.", required=True, type=ext_check(".bam", ".sam", "-"))
parser.add_argument("--uncompressed", "Output uncompressed BAM.", action='store_true')
parser.add_argument("--start-only", help="Reads only need the same start position and the same UMI to be considered duplicates.", action='store_true')
parser.add_argument("--seed", help="Random number generator seed.", default=42, type=int)
parser.add_argument("--version", help="Display version number.", action='version', version=subprocess.check_output(["fumi_tools_dedup", "--version"]).decode())

args = parser.parse_args()

dedup_process = subprocess.Popen(["fumi_tools_dedup", "--input", args.input,
                                                      "--output=-",
                                                      "--start-only" if args.start_only else "",
                                                      "--seed", str(args.seed),
                                                      "--uncompressed" if args.uncompressed else ""], stdout=subprocess.PIPE)
sort_process = subprocess.Popen(["samtools", "sort", "-n"], stdin=dedup_process.stdout, stdout=subprocess.PIPE)
fix_process = subprocess.Popen(["fumi_tools_fix_flags", "--input=-", "--output", args.output], stdin=sort_process.stdout)
dedup_process.stdout.close()
sort_process.stdout.close()
output = fix_process.communicate()[0]

if dedup_process.returncode != 0:
    sys.exit(dedup_process.returncode)
if sort_process.returncode != 0:
    sys.exit(sort_process.returncode)
if fix_process.returncode != 0:
    sys.exit(fix_process.returncode)

sys.exit(0)
